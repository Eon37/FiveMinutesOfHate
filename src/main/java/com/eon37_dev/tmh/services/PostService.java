package com.eon37_dev.tmh.services;

import com.eon37_dev.tmh.model.Post;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ThreadLocalRandom;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Service
public class PostService {
  public static class ClientAuthors {
    private static final Object USER_LIST_LOCK = new Object();
    private static final Map<String, String> ASS_USER_NAMES = new ConcurrentHashMap<>(Author.ALL_AUTHORS.size());

    public static String assignAuthor(String clientId) {
      return ASS_USER_NAMES.computeIfAbsent(clientId, k -> Author.borrowAuthor());
    }

    public static void returnAuthor(String clientId) {
      Author.returnAuthor(ASS_USER_NAMES.remove(clientId));
    }

    private static class Author {
      private static final LinkedList<String> ALL_AUTHORS = new LinkedList<>(Set.of(
              "Housefly", "Fruit Fly", "Horsefly", "Deer Fly", "Botfly", "Tsetse Fly", "Sandfly", "Blackfly", "Blowfly", "Flesh Fly", "Stable Fly", "Crane Fly", "Mosquito", "Culex Mosquito", "Anopheles Mosquito", "Aedes Mosquito", "Tiger Mosquito", "Moth Fly", "Whitefly", "Mayfly", "Dragonfly", "Damselfly", "Stonefly", "Dobsonfly", "Alderfly", "Snakefly", "Caddisfly", "Butterfly", "Monarch Butterfly", "Viceroy Butterfly", "Swallowtail Butterfly", "Tiger Swallowtail", "Black Swallowtail", "Spicebush Swallowtail", "Pipevine Swallowtail", "Zebra Swallowtail", "Blue Swallowtail", "Giant Swallowtail", "Mourning Cloak", "Painted Lady", "American Lady", "Red Admiral", "Common Buckeye", "Question Mark", "Comma Butterfly", "Tortoiseshell Butterfly", "Peacock Butterfly", "Blue Morpho", "Owl Butterfly", "Glasswing Butterfly", "Cabbage White", "Sulphur Butterfly", "Clouded Sulphur", "Orange Sulphur", "Dogface Butterfly", "Sleepy Orange", "Hairstreak Butterfly", "Gray Hairstreak", "Banded Hairstreak", "Striped Hairstreak", "Coral Hairstreak", "Copper Butterfly", "American Copper", "Bronze Copper", "Purple Copper", "Checkerspot Butterfly", "Baltimore Checkerspot", "Silvery Checkerspot", "Pearl Crescent", "Northern Crescent", "Fritillary Butterfly", "Great Spangled Fritillary", "Variegated Fritillary", "Diana Fritillary", "Gulf Fritillary", "Satyr Butterfly", "Common Wood Nymph", "Ringlet Butterfly", "Meadow Brown", "Speckled Wood", "Skipper Butterfly", "Silver-spotted Skipper", "Peck’s Skipper", "Fiery Skipper", "Clouded Skipper", "Least Skipper", "Hummingbird Moth", "Sphinx Moth", "Hawk Moth", "Death’s-head Hawkmoth", "Hummingbird Hawk Moth", "Clearwing Moth", "Luna Moth", "Polyphemus Moth", "Cecropia Moth", "Io Moth", "Promethea Moth", "Rosy Maple Moth", "Atlas Moth", "Silkworm Moth", "Emperor Moth", "Tiger Moth", "Isabella Tiger Moth", "Woolly Bear Caterpillar", "Leopard Moth", "Scarlet Tiger Moth", "Cinnabar Moth", "Forester Moth", "Burnet Moth", "Owlet Moth", "Cutworm Moth", "Armyworm Moth", "Looper Moth", "Underwing Moth", "Yellow Underwing", "Angle Shades Moth", "Carpet Moth", "Clothes Moth", "Pantry Moth", "Indianmeal Moth", "Codling Moth", "Gypsy Moth", "Winter Moth", "Fall Webworm Moth", "Tent Caterpillar Moth", "Bagworm Moth", "Leafroller Moth", "Tortrix Moth", "Diamondback Moth", "Cabbage Moth", "Corn Earworm Moth", "Tomato Hornworm Moth", "Hummingbird Clearwing", "Bee Hawk Moth", "Puss Moth", "Buff-tip Moth", "Iron Prominent", "White Ermine Moth", "Buff Ermine Moth", "Garden Tiger Moth", "Jersey Tiger Moth", "Brown-tail Moth", "Black Arches Moth", "Rustic Shoulder-knot", "Large Yellow Underwing", "Small Yellow Underwing", "Heart and Dart Moth", "Shuttle-shaped Dart Moth", "Knot Grass Moth", "Flame Shoulder", "Hebrew Character Moth", "Setaceous Hebrew Character", "Common Quaker", "Small Quaker", "Twin-spotted Quaker", "Clouded Drab", "Red Chestnut", "Early Grey", "Herald Moth", "Angle-striped Sallow", "Barred Sallow", "Pink-barred Sallow", "Straw Dot Moth", "Mother Shipton Moth", "Burnished Brass Moth", "Spectacle Moth", "Dark Arches Moth", "Light Arches Moth", "Common Footman", "Scarce Footman", "Dingy Footman", "Hoary Footman", "Buff Footman", "Round-winged Muslin", "Muslin Moth", "Ruby Tiger Moth", "Scarlet Tiger", "Wood Tiger Moth", "Garden Carpet", "Large Twin-spot Carpet", "Small Phoenix", "Common Carpet", "Spruce Carpet", "Silver-ground Carpet", "Yellow Shell Moth", "Magpie Moth", "Clouded Border", "Brown Silver-line", "Silver Y Moth", "Rush Veneer", "Pale Mottled Willow", "Dark Sword-grass", "Turnip Moth", "Beet Armyworm", "Beet Moth", "Miller Moth", "Tussock Moth", "White-marked Tussock Moth", "Defoliating Tussock Moth", "Pine Processionary Moth", "Oak Processionary Moth", "Fall Armyworm", "Beet Webworm", "Grass Moth", "Crambid Snout Moth", "Sod Webworm", "Stalk Borer Moth", "European Corn Borer", "Southwestern Corn Borer", "Asiatic Rice Borer", "African Armyworm", "Cereal Leaf Beetle Moth", "Rice Leafroller", "Greenhouse Moth", "Tobacco Budworm", "Tobacco Hornworm", "Potato Tuberworm", "Onion Maggot Fly", "Carrot Rust Fly", "Bean Fly", "Seedcorn Maggot", "Cabbage Root Fly", "Root Maggot Fly", "Hoverfly", "Drone Fly", "Syrphid Fly", "Flower Fly", "Thick-headed Fly", "Robber Fly", "Bee Fly", "Dance Fly", "Snipe Fly", "Stiletto Fly", "Soldier Fly", "Gall Midge", "Fungus Gnat", "Sciarid Fly", "Phorid Fly", "Humpbacked Fly", "Eye Gnat", "Eye Fly", "Louse Fly", "Sheep Ked", "Bat Fly", "Flat Fly", "Leaf Miner Fly", "Agromyzid Fly", "Picture-winged Fly", "Tephritid Fly", "Mediterranean Fruit Fly", "Olive Fruit Fly", "Apple Maggot Fly", "Cherry Fruit Fly", "Bluebottle Fly", "Greenbottle Fly", "Bronze Bottle Fly", "Cluster Fly", "House Gnat", "Sand Gnat", "Buffalo Gnat", "Eye Mosquito", "Black Mosquito", "Asian Tiger Mosquito", "Yellow Fever Mosquito", "Malaria Mosquito", "Sand Mosquito", "Elephant Mosquito", "Leaf Midge", "Blossom Midge", "Hessian Fly", "Wheat Midge", "Barley Midge", "Oat Midge", "Cereal Midge", "Cabbage Midge", "Clover Midge", "Carrot Midge", "Onion Midge", "Brassica Pod Midge", "Pea Midge", "Spinach Leafminer", "Tomato Leafminer", "Chrysanthemum Leafminer", "Potato Leafminer", "Cabbage Leafminer", "Bean Leafminer", "Corn Leafminer", "Grass Leafminer", "Birch Leafminer", "Elm Leafminer", "Oak Leafminer", "Pine Needle Miner", "Spruce Needle Miner", "Fir Needle Miner", "Larch Needle Miner", "Leafcutter Ant", "Army Ant", "Driver Ant", "Fire Ant", "Carpenter Ant", "Weaver Ant", "Bullet Ant", "Black Garden Ant", "Pharaoh Ant", "Ghost Ant", "Crazy Ant", "Argentine Ant", "Velvety Tree Ant", "Red Imported Fire Ant", "Pavement Ant", "Yellow Crazy Ant", "Asian Needle Ant", "Trap-jaw Ant", "Leafcutter Bee", "Honeybee", "Bumblebee", "Carpenter Bee", "Sweat Bee", "Mining Bee", "Mason Bee", "Cuckoo Bee", "Digger Bee", "Long-horned Bee", "Orchid Bee", "Stingless Bee", "Killer Bee", "Drone Bee", "Worker Bee", "Queen Bee", "Wasp", "Yellowjacket", "Hornet", "European Hornet", "Asian Giant Hornet", "Bald-faced Hornet", "Paper Wasp", "Potter Wasp", "Mason Wasp", "Cuckoo Wasp", "Emerald Wasp", "Velvet Ant", "Cow Killer", "Parasitoid Wasp", "Ichneumon Wasp", "Braconid Wasp", "Chalcid Wasp", "Gall Wasp", "Fig Wasp", "Cynipid Wasp", "Spider Wasp", "Mud Dauber", "Cicada Killer", "Tarantula Hawk", "Sawfly", "Birch Sawfly", "Pine Sawfly", "Elm Sawfly", "Rose Sawfly", "Gooseberry Sawfly", "Willow Sawfly", "Maple Sawfly", "Oak Sawfly", "Spruce Sawfly", "Fir Sawfly", "Cicada", "Periodical Cicada", "Annual Cicada", "Dog-day Cicada", "Green Grocer Cicada", "Cherrynose Cicada", "Redeye Cicada", "Grasshopper", "Locust", "Katydid", "Bush-cricket", "Mormon Cricket", "Camel Cricket", "Cave Cricket", "Sand Treader Cricket", "Jerusalem Cricket", "Tree Cricket", "Field Cricket", "Mole Cricket", "Ground Cricket", "Ant Cricket", "Pygmy Grasshopper", "Pillbug Grasshopper", "Band-winged Grasshopper", "Spur-throated Grasshopper", "Slant-faced Grasshopper", "Short-horned Grasshopper", "Long-horned Grasshopper", "Meadow Grasshopper", "Marsh Grasshopper", "Desert Locust", "Migratory Locust", "Red Locust", "Bombay Locust", "Italian Locust", "Spur-throated Locust", "Plague Locust", "African Locust", "Australian Plague Locust", "Spotted Grasshopper", "Rainbow Grasshopper", "Lubber Grasshopper", "Horse Lubber", "Eastern Lubber", "Western Lubber", "Praying Mantis", "Chinese Mantis", "European Mantis", "Carolina Mantis", "African Mantis", "Orchid Mantis", "Devil’s Flower Mantis", "Ghost Mantis", "Spiny Flower Mantis", "Dead Leaf Mantis", "Stick Insect", "Walking Stick", "Leaf Insect", "Giant Walking Stick", "Goliath Stick Insect", "Maclay’s Spectre", "Pink-winged Stick Insect", "Spiny Stick Insect", "Bark Mimic Stick Insect", "Atlas Moth Stick Insect", "Cockroach", "American Cockroach", "German Cockroach", "Oriental Cockroach", "Smokybrown Cockroach", "Brown-banded Cockroach", "Australian Cockroach", "Florida Woods Cockroach", "Death’s Head Cockroach", "Dubia Roach", "Lobster Roach", "Pale Bordered Field Roach", "Termite", "Subterranean Termite", "Drywood Termite", "Dampwood Termite", "Conehead Termite", "Formosan Termite", "West Indian Termite", "Nasute Termite", "Conehead Nasute", "Large Nasute", "Earwig", "Common Earwig", "Ringlegged Earwig", "Striped Earwig", "Seashore Earwig", "Tawny Earwig", "Lesser Earwig", "Saint Helena Earwig", "Giant Earwig", "Silverfish", "Firebrat", "Jumping Bristletail", "Bristletail", "Booklouse", "Barklouse", "Woodlouse", "Parasitic Louse", "Head Louse", "Body Louse", "Pubic Louse", "Chewing Louse", "Bird Louse", "Mammal Louse", "Bat Bug", "Bed Bug", "Kissing Bug", "Assassin Bug", "Wheel Bug", "Ambush Bug", "Thread-legged Bug", "Water Strider", "Pond Skater", "Backswimmer", "Water Boatman", "Giant Water Bug", "Creeping Water Bug", "Water Scorpion", "Toad Bug", "Pill Bug", "Seed Bug", "Stink Bug", "Shield Bug", "Green Stink Bug", "Brown Marmorated Stink Bug", "Harlequin Bug", "Boxelder Bug", "Red Bug", "Milkweed Bug", "Small Milkweed Bug", "Large Milkweed Bug", "Aphid", "Greenfly", "Blackfly (aphid)", "Woolly Aphid", "Root Aphid", "Cabbage Aphid", "Pea Aphid", "Soybean Aphid", "White Peach Aphid", "Cotton Aphid", "Scale Insect", "Mealybug", "Cottony Cushion Scale", "Brown Soft Scale", "San Jose Scale", "Oyster Shell Scale", "Pine Needle Scale", "Armored Scale", "Cochineal", "Leafhopper", "Sharpshooter", "Spittlebug", "Froghopper", "Planthopper", "Lanternfly", "Cicadellid Leafhopper", "Treehopper", "Membracid Treehopper", "Gladiator Bug", "Webspinner", "Twisted-wing Parasite", "Scorpionfly", "Mecoptera", "Snow Flea", "Springtail", "Ice Crawler", "Grylloblattid", "Rock Crawler", "Mantophasmatodea", "Heel-walker", "Mayfly Nymph", "Dragonfly Nymph", "Damselfly Nymph", "Stonefly Nymph", "Dobsonfly Larva", "Hellgrammite", "Caddisfly Larva", "Bagworm Larva", "Antlion", "Owlflies", "Snakeflies", "Bee Beetle", "Ladybug", "Seven-spotted Ladybug", "Two-spotted Ladybug", "Asian Lady Beetle", "Convergent Lady Beetle", "Mexican Bean Beetle", "Colorado Potato Beetle", "Flea Beetle", "Cucumber Beetle", "Ground Beetle", "Tiger Beetle", "Bombardier Beetle", "Stag Beetle", "Hercules Beetle", "Atlas Beetle", "Elephant Beetle", "Rhinoceros Beetle", "Unicorn Beetle", "Flower Beetle", "Scarab Beetle", "Dung Beetle", "June Bug", "May Beetle", "Japanese Beetle", "Rose Chafer", "Green June Beetle", "Goliath Beetle", "Firefly", "Lightning Bug", "Click Beetle", "Wireworm", "Elaterid Beetle", "Darkling Beetle", "Mealworm Beetle", "Superworm Beetle", "Blister Beetle", "Oil Beetle", "Soldier Beetle", "Cantharid Beetle", "Carrion Beetle", "Sexton Beetle", "Rove Beetle", "Sap Beetle", "Nitidulid Beetle", "Shining Flower Beetle", "Checkered Beetle", "Clerid Beetle", "Bark Beetle", "Ambrosia Beetle", "Weevil", "Boll Weevil", "Rice Weevil", "Granary Weevil", "Bean Weevil", "Pea Weevil", "Root Weevil", "Vine Weevil", "Snout Beetle", "True Weevil", "Longhorn Beetle", "Cottonwood Borer", "Pine Sawyer Beetle", "Asian Longhorn Beetle", "Musk Beetle", "Timberman Beetle", "Capricorn Beetle", "Leaf Beetle", "Tortoise Beetle", "Altica Flea Beetle", "Chrysolina Beetle", "Willow Beetle", "Elm Leaf Beetle", "Spotted Cucumber Beetle", "Striped Cucumber Beetle", "Seed Beetle", "Predaceous Diving Beetle", "Water Scavenger Beetle", "Haliplid Beetle", "Hydrophilid Beetle", "Silver Water Beetle", "Water Penny Beetle", "Whirligig Beetle", "Aquatic Rove Beetle", "Bess Beetle", "Horned Passalus", "Feather-winged Beetle", "Minute Beetle", "Ptiliid Beetle", "Psephenid Beetle", "Net-winged Beetle", "Fire-colored Beetle", "Soft-winged Flower Beetle", "Scraptiid Beetle", "Derodontid Beetle", "Cucujid Beetle", "Flat Bark Beetle", "Silvanid Beetle", "Larder Beetle", "Carpet Beetle", "Varied Carpet Beetle", "Black Carpet Beetle", "Furniture Carpet Beetle", "Dermestid Beetle", "Hide Beetle", "Skin Beetle", "Book Beetle", "Drugstore Beetle", "Cigarette Beetle", "Spider Beetle", "Ptinid Beetle", "Spider", "Harvestman", "Tick", "Mite",
              "Black Widow", "Latrodectus mactans", "Brown Recluse", "Loxosceles reclusa", "Goliath Birdeater", "Theraphosa blondi", "Arizona Bark Scorpion", "Centruroides sculpturatus", "Camel Spider", "Galeodes arabs", "Redback Spider", "Latrodectus hasselti", "Hobo Spider", "Eratigena agrestis", "Brazilian Wandering Spider", "Phoneutria nigriventer", "Emperor Scorpion", "Pandinus imperator", "Opilio parietinus", "Ixodes scapularis", "Deer Tick", "Ixodes dammini", "Dog Tick", "Dermacentor variabilis", "Lone Star Tick", "Amblyomma americanum", "House Spider", "Parasteatoda tepidariorum", "Wolf Spider", "Lycosidae", "Jumping Spider", "Salticidae", "Trapdoor Spider", "Ctenizidae", "Sydney Funnel-Web Spider", "Atrax robustus", "Mouse Spider", "Missulena bradleyi", "Golden Orb-Weaver", "Nephila clavipes", "Banana Spider", "Nephila pilipes", "Garden Spider", "Araneus diadematus", "Cross Orbweaver", "Araneus cavaticus", "Fishing Spider", "Dolomedes tenebrosus", "Six-eyed Sand Spider", "Sicarius hahni", "Chilean Recluse", "Loxosceles laeta", "Crab Spider", "Thomisidae", "Green Lynx Spider", "Peucetia viridans", "Whip Scorpion", "Mastigoproctus giganteus", "Vinegaroon", "Mastigoproctus tohono", "Sun Spider", "Solifugae", "Tailless Whip Scorpion", "Amblypygi", "Giant Huntsman Spider", "Heteropoda maxima", "Golden Huntsman", "Heteropoda venatoria", "Texas Cave Scorpion", "Pseudouroctonus reddelli", "Arizona Giant Hairy Scorpion", "Hadrurus arizonensis", "Stripe-tailed Scorpion", "Paravaejovis spinigerus", "Yellow Fat-tailed Scorpion", "Androctonus australis", "Deathstalker", "Leiurus quinquestriatus", "Man-faced Spider", "Cyclocosmia truncata", "Bird-dropping Spider", "Celaenia excavata", "Peacock Spider", "Maratus volans", "Zebra Spider", "Salticus scenicus", "Bold Jumping Spider", "Phidippus audax", "Regal Jumping Spider", "Phidippus regius", "Pink Toe Tarantula", "Avicularia avicularia", "Mexican Redknee Tarantula", "Brachypelma smithi", "Greenbottle Blue Tarantula", "Chromatopelma cyaneopubescens", "Cyriopagopus lividus", "Chaco Golden Knee", "Grammostola pulchripes", "Rose Hair Tarantula", "Grammostola rosea", "Curly Hair Tarantula", "Tliltocatl albopilosus", "Salmon Pink Birdeater", "Lasiodora parahybana", "Pinkfoot Goliath Tarantula", "Theraphosa apophysis", "Skeleton Tarantula", "Ephebopus murinus", "Trinidad Chevron Tarantula", "Psalmopoeus cambridgei", "Indian Ornamental Tarantula", "Poecilotheria regalis", "Sri Lankan Ornamental Tarantula", "Poecilotheria fasciata", "Fringed Ornamental", "Poecilotheria ornata", "Leopard Tarantula", "Poecilotheria subfusca", "Red Slate Ornamental", "Poecilotheria rufilata", "Malabar Ornamental", "Poecilotheria smithi", "Koch’s Tarantula", "Poecilotheria tigrinawesseli", "Tiger Spider", "Poecilotheria striata", "Ghost Ornamental", "Poecilotheria vittata", "Horned Baboon Tarantula", "Ceratogyrus darlingi", "Blue Baboon Tarantula", "Monocentropus balfouri", "Sociable Baboon Spider", "Pelinobius muticus", "King Baboon Spider", "Heteroscodra maculata", "Togo Starburst Tarantula", "Stromatopelma calceatum", "Featherleg Baboon Spider", "Tapinauchenius gigas", "Orange Tree Spider", "Tapinauchenius violaceus", "Purple Tree Spider", "Avicularia purpurea", "Purple Pinktoe", "Psalmopoeus irminia", "Venezuelan Suntiger", "Haplopelma albostriatum", "Thai Zebra Tarantula", "Cyriopagopus schioedtei", "Malaysian Earth Tiger", "Chilobrachys fimbriatus", "Indian Violet Tarantula", "Chilobrachys huahini", "Thai Black Tarantula", "Chilobrachys dyscolus", "Vietnam Blue Tarantula", "Haplopelma minax", "Thailand Black Tarantula", "Haplopelma lividum", "Cobalt Blue Tarantula", "Lampropelma violaceopes", "Singapore Blue Tarantula", "Omothymus schioedtei", "Malaysian Blue Tarantula", "Ephebopus cyanognathus", "Blue Fang Tarantula", "Harpactira pulchripes", "Golden Blue Leg Baboon", "Hysterocrates gigas", "Cameroon Red Baboon", "Pterinochilus murinus", "Orange Baboon Tarantula", "Augacephalus junodi", "Golden Starburst Baboon", "Idiothele mira", "Trapdoor Baboon Spider", "Scorpion-tailed Spider", "Arachnura higginsi", "Spiny Orb-weaver", "Gasteracantha cancriformis", "Micrathena Spider", "Micrathena sagittata", "Bird Dung Crab Spider", "Phrynarachne decipiens", "Pelican Spider", "Archaeidae", "Pirate Spider", "Mimetidae", "Raft Spider", "Dolomedes fimbriatus", "Nursery Web Spider", "Pisaura mirabilis", "Two-tailed Spider", "Hersiliidae", "Flattie Spider", "Selenopidae", "Purseweb Spider", "Atypidae", "Raven’s Trapdoor Spider", "Stasimopus sp.", "Desert Recluse", "Loxosceles deserta", "Mediterranean Recluse", "Loxosceles rufescens", "Texas Recluse", "Loxosceles devia", "African Velvet Spider", "Eresidae", "Velvet Spider", "Gandanameno sp.", "Feather-legged Spider", "Uloboridae", "Net-casting Spider", "Deinopis subrufa", "Funnel Weaver", "Agelenidae", "Hackled Orb-weaver", "Uloborus plumipes", "Lace Web Spider", "Amaurobius ferox", "Woodlouse Spider", "Dysdera crocata", "Mesh Web Spider", "Dictynidae", "Feather-legged Lace Spider", "Uloborus walckenaerius", "Long-legged Sac Spider", "Cheiracanthium mildei", "Yellow Sac Spider", "Cheiracanthium inclusum", "Clubionid Spider", "Clubiona trivialis", "Tube Web Spider", "Segestria florentina", "Sea Spider", "Pycnogonida", "Water Mite", "Hydrachnidia", "Velvet Mite", "Trombidiidae", "Red Velvet Mite", "Trombidium grandissimum", "Chigger", "Trombiculidae", "Harvest Mite", "Neotrombicula autumnalis", "Itch Mite", "Sarcoptes scabiei", "Ear Mite", "Otodectes cynotis", "Spider Mite", "Tetranychus urticae", "Broad Mite", "Polyphagotarsonemus latus", "Gall Mite", "Eriophyes tiliae", "Rust Mite", "Aceria anthocoptes", "Bark Scorpion", "Centruroides vittatus", "Striped Bark Scorpion", "Centruroides margaritatus", "Forest Scorpion", "Heterometrus spinifer", "Asian Forest Scorpion", "Heterometrus longimanus", "Giant Forest Scorpion", "Heterometrus swammerdami", "Black Forest Scorpion", "Heterometrus cyaneus", "Tanzanian Red-claw Scorpion", "Pandinus cavimanus", "Flat Rock Scorpion", "Hadogenes troglodytes", "Rock Scorpion", "Hadogenes paucidens", "Cape Scorpion", "Opisthacanthus asper", "Brazilian Black Tarantula", "Grammostola pulchra", "Burgundy Goliath Birdeater", "Theraphosa stirmi", "Desert Hairy Scorpion", "Hadrurus spadix", "Indian Red Scorpion", "Hottentotta tamulus", "Arabian Fat-tailed Scorpion", "Androctonus crassicauda", "Transvaal Fat-tailed Scorpion", "Parabuthus transvaalicus", "Thick-tailed Scorpion", "Parabuthus granulatus", "Cape Burrower Scorpion", "Opistophthalmus capensis", "Spitting Scorpion", "Parabuthus schlechteri", "Two-tailed Whip Scorpion", "Damon diadema", "Tanzanian Whip Spider", "Damon variegatus", "Cave Whip Spider", "Charinus ioanniticus", "Madagascan Whip Spider", "Phrynichus ceylonicus",
              "Strep throat bacteria", "Streptococcus pyogenes", "TB bacteria", "Mycobacterium tuberculosis", "Anthrax bacteria", "Bacillus anthracis", "Yogurt bacteria", "Lactobacillus bulgaricus", "Gut flora bacteria", "Bacteroides fragilis", "Salmonella", "Salmonella enterica", "Cholera bacteria", "Vibrio cholerae", "Black Death bacteria", "Tetanus bacteria", "Clostridium tetani", "Botulism bacteria", "Clostridium botulinum", "Gas gangrene bacteria", "Diphtheria bacteria", "Corynebacterium diphtheriae", "Whooping cough bacteria", "Bordetella pertussis", "Meningitis bacteria", "Neisseria meningitidis", "Gonorrhea bacteria", "Neisseria gonorrhoeae", "Syphilis bacteria", "Treponema pallidum", "Lyme disease bacteria", "Borrelia burgdorferi", "Stomach ulcer bacteria", "Leprosy bacteria", "Mycobacterium leprae", "Legionnaires' disease bacteria", "Legionella pneumophila", "Pneumonia bacteria", "Streptococcus pneumoniae", "Staph infection bacteria", "Staphylococcus aureus", "MRSA", "Methicillin-resistant Staphylococcus aureus", "Listeria", "Listeria monocytogenes", "Campylobacter", "Campylobacter jejuni", "Typhoid fever bacteria", "Salmonella Typhi", "Shigella", "Shigella dysenteriae", "Klebsiella", "Klebsiella pneumoniae", "Proteus", "Proteus mirabilis", "Pseudomonas", "Pseudomonas aeruginosa", "Haemophilus", "Haemophilus influenzae", "Brucella", "Brucella abortus", "Tularemia bacteria", "Francisella tularensis", "Chlamydia", "Chlamydia trachomatis", "Plague bacteria", "Yersinia pestis", "Dental plaque bacteria", "Streptococcus mutans", "Food poisoning bacteria", "Clostridium perfringens", "Gastroenteritis bacteria", "Vibrio parahaemolyticus", "Sepsis bacteria", "Enterococcus faecalis", "UTI bacteria", "Escherichia coli", "Acne bacteria", "Cutibacterium acnes", "Diptheria-like bacteria", "Corynebacterium ulcerans", "Q fever bacteria", "Coxiella burnetii", "Cat scratch disease bacteria", "Bartonella henselae", "Trench fever bacteria", "Bartonella quintana", "Rat-bite fever bacteria", "Streptobacillus moniliformis", "Whipple's disease bacteria", "Tropheryma whipplei", "Peptic ulcer bacteria", "Helicobacter pylori", "Neonatal meningitis bacteria", "Escherichia coli K1", "Food spoilage bacteria", "Clostridium sporogenes", "Cyanobacteria (blue-green algae)", "Anabaena", "Spirulina", "Arthrospira platensis", "Nitrogen-fixing bacteria", "Rhizobium leguminosarum", "Root nodule bacteria", "Bradyrhizobium japonicum", "Soil bacteria", "Streptomyces griseus", "Antibiotic producer bacteria", "Streptomyces avermitilis", "Actinobacteria", "Actinomyces israelii", "Dental abscess bacteria", "Actinomyces viscosus", "Cheese bacteria", "Lactococcus lactis", "Kefir bacteria", "Lactobacillus kefiri", "Probiotic bacteria", "Bifidobacterium longum", "Infant gut bacteria", "Bifidobacterium breve", "Skin bacteria", "Staphylococcus epidermidis", "Deep-sea vent bacteria", "Thermococcus gammatolerans", "Heat-loving bacteria", "Taq polymerase bacteria", "Salt-loving bacteria", "Halobacterium salinarum", "Radiation-resistant bacteria", "Deinococcus radiodurans", "Sulfur bacteria", "Beggiatoa", "Iron bacteria", "Gallionella ferruginea", "Methane-producing bacteria", "Methanobrevibacter smithii", "Ammonia-oxidizing bacteria", "Nitrosomonas europaea", "Nitrite-oxidizing bacteria", "Nitrobacter winogradskyi", "Lactic acid bacteria", "Lactobacillus acidophilus", "Pickle fermentation bacteria", "Leuconostoc mesenteroides", "Wine fermentation bacteria", "Oenococcus oeni", "Beer spoilage bacteria", "Pediococcus damnosus", "Sourdough bacteria", "Lactobacillus sanfranciscensis", "Butter bacteria", "Leuconostoc lactis", "Soy sauce bacteria", "Tetragenococcus halophilus", "Miso bacteria", "Zygosaccharomyces rouxii", "Fish spoilage bacteria", "Shewanella putrefaciens", "Marine bacteria", "Vibrio vulnificus", "Bioluminescent bacteria", "Vibrio fischeri", "Oil-eating bacteria", "Alcanivorax borkumensis", "Plastic-eating bacteria", "Ideonella sakaiensis", "Radiation survivors", "Deinococcus geothermalis", "Desert bacteria", "Micrococcus luteus", "Arctic bacteria", "Psychrobacter cryohalolentis", "Glacier bacteria", "Polaromonas glacialis", "Thermophiles", "Thermotoga maritima", "Hydrothermal vent bacteria", "Aquifex aeolicus", "Sulfur reducers", "Desulfovibrio vulgaris", "Magnetotactic bacteria", "Magnetospirillum magneticum", "Spiral bacteria", "Spirillum volutans", "Curved rod bacteria", "Campylobacter coli", "Tiny bacteria", "Mycoplasma pneumoniae", "Cell-wall-less bacteria", "Ureaplasma urealyticum", "Smallest bacteria", "Nanoarchaeum equitans", "Archaea methane bacteria", "Methanococcus jannaschii", "Acid-loving bacteria", "Acidithiobacillus ferrooxidans", "Alkaline bacteria", "Bacillus alcalophilus", "Desert crust bacteria", "Nostoc commune", "Cave bacteria", "Leptospira interrogans", "Weil’s disease bacteria", "Leptospira borgpetersenii", "Rice blast bacteria", "Xanthomonas oryzae", "Citrus canker bacteria", "Xanthomonas axonopodis", "Fire blight bacteria", "Erwinia amylovora", "Crown gall bacteria", "Agrobacterium tumefaciens", "Potato scab bacteria", "Streptomyces scabies", "Olive knot bacteria", "Pseudomonas savastanoi", "Banana wilt bacteria", "Ralstonia solanacearum", "Tomato canker bacteria", "Clavibacter michiganensis", "Soybean rust bacteria", "Phakopsora pachyrhizi", "Blue cheese bacteria", "Penicillium roqueforti (symbiotic)", "Swiss cheese holes bacteria", "Propionibacterium freudenreichii", "Nitrogen-fixing cyanobacteria", "Nostoc punctiforme", "Slime bacteria", "Myxococcus xanthus", "Gliding bacteria", "Flavobacterium johnsoniae", "Marine snow bacteria", "Alteromonas macleodii", "Whale gut bacteria", "Cetobacterium somerae", "Shrimp gut bacteria", "Vibrio penaeicida", "Squid symbiont", "Aliivibrio fischeri", "Coral symbiont bacteria", "Endozoicomonas montiporae", "Spore-forming bacteria", "Bacillus subtilis", "Hay bacillus", "Bacillus subtilis var. natto", "Soybean natto bacteria", "Bacillus subtilis natto", "Root symbiont bacteria", "Frankia alni", "Marine extremophile", "Marinobacter hydrocarbonoclasticus", "Thermoacidophiles", "Sulfolobus acidocaldarius", "Acid mine bacteria", "Ferroplasma acidarmanus", "Uranium waste bacteria", "Geobacter metallireducens", "Electric bacteria", "Shewanella oneidensis", "Rock-eating bacteria", "Acidithiobacillus thiooxidans", "Limestone cave bacteria", "Thiobacillus denitrificans", "Cement bacteria", "Sporosarcina pasteurii", "Bacteriophage host bacteria", "Escherichia coli K12", "Industrial yeast symbiont bacteria", "Zymomonas mobilis", "Ethyl alcohol bacteria", "Acetobacter aceti", "Vinegar bacteria", "Gluconobacter oxydans", "Butanol fermentation bacteria", "Clostridium acetobutylicum", "Syntrophic bacteria", "Syntrophomonas wolfei", "Hydrogen-producing bacteria", "Clostridium butyricum", "Biogas bacteria", "Methanosarcina barkeri", "Halophiles", "Halomonas elongata", "Deep subsurface bacteria", "Desulforudis audaxviator", "Coal mine bacteria", "Leptospirillum ferrooxidans", "Hot spring bacteria", "Chloroflexus aurantiacus", "Green sulfur bacteria", "Chlorobium tepidum", "Purple sulfur bacteria", "Chromatium okenii", "Purple non-sulfur bacteria", "Rhodospirillum rubrum", "Photosynthetic bacteria", "Rhodobacter sphaeroides", "Oxygenic cyanobacteria", "Synechococcus elongatus", "Tiny parasite bacteria", "Rickettsia prowazekii", "Typhus bacteria", "Rickettsia typhi", "Rocky Mountain spotted fever bacteria", "Rickettsia rickettsii", "Scrub typhus bacteria", "Orientia tsutsugamushi", "Parrot fever bacteria", "Chlamydophila psittaci", "Plant symbiont bacteria", "Azospirillum brasilense", "Corn root bacteria", "Herbaspirillum seropedicae", "Aquarium nitrogen bacteria", "Nitrosococcus oceani", "Fish pathogen bacteria", "Aeromonas hydrophila", "Frog pathogen bacteria", "Chlamydophila pneumoniae", "Snake pathogen bacteria", "Salmonella bongori", "Bat gut bacteria", "Desulfotomaculum reducens", "Whale fall bacteria", "Colwellia psychrerythraea", "Polar extremophile bacteria", "Psychromonas ingrahamii"
      ));
      private static int AVAILABLE = ALL_AUTHORS.size();
      private static int SEQ = 0;
      private static int RET_SEQ = 0;

      private static String borrowAuthor() {
        synchronized (USER_LIST_LOCK) {
          if (AVAILABLE > 0) {
            int next = ThreadLocalRandom.current().nextInt(AVAILABLE--);
            String nextName = ALL_AUTHORS.remove(next);
            ALL_AUTHORS.addLast(nextName);
            return nextName;
          } else {
            int next = ThreadLocalRandom.current().nextInt(ALL_AUTHORS.size());
            String nextName = ALL_AUTHORS.get(next);
            return nextName + "#" + ++SEQ;
          }
        }
      }


      private static void returnAuthor(String author) {
        String toReturn = ASS_USER_NAMES.remove(author);
        synchronized (USER_LIST_LOCK) {
          if (toReturn.contains("#")) {
            if (++RET_SEQ == SEQ) {
              SEQ = 0;
              RET_SEQ = 0;
            }
          } else {
            ALL_AUTHORS.remove(toReturn);
            ALL_AUTHORS.addFirst(toReturn);
            AVAILABLE++;
          }
        }
      }
    }
  }

  private static final Map<Long, Post> POSTS = new ConcurrentHashMap<>();

  public Map<Long, Post> getPosts() {
    return POSTS;
  }

  public Post newPost(String clientId, String text, boolean anonymous) {
    String author = ClientAuthors.assignAuthor(clientId);
    long createTime = System.nanoTime() * 10 + ThreadLocalRandom.current().nextInt(10);

    Post newPost = Post.builder()
            .id(createTime)
            .clientId(clientId)
            .author(author)
            .anonymous(anonymous)
            .text(text)
            .build(true);

    POSTS.put(createTime, newPost);

    return newPost;
  }

  public int likePost(String clientId, Long id) {
    Optional<Post> post = Optional.ofNullable(POSTS.get(id));

    return post.map(op -> op.incrementLikes(clientId)).orElse(1);
  }

  public int likeComment(String clientId, Long id, Long commentId) {
    Optional<Post> post = Optional.ofNullable(POSTS.get(id));

    post.ifPresent(op -> op.getComments().get(commentId).incrementLikes(clientId));

    return post.map(op -> op.getComments().get(commentId).getLikes().size()).orElse(1);
  }

  public Map<Long, Post> newComment(String clientId, Long id, String text) {
    String author = ClientAuthors.assignAuthor(clientId);
    Optional<Post> post = Optional.ofNullable(POSTS.get(id));

    Long createTime = System.nanoTime() * 10 + ThreadLocalRandom.current().nextInt();
    Post newComment = Post.builder()
            .id(createTime)
            .clientId(clientId)
            .author(author)
            .text(text)
            .build(false);

    post.ifPresent(op -> {
      op.getComments().put(createTime, newComment);

      op.incrementExpire();
    });

    return Map.of(createTime, newComment);
  }

  public void deletePostsByTime() {
    Map<String, String> authorsClientId = POSTS.entrySet().stream()
            .filter(entry -> entry.getValue().getExpire() <= System.nanoTime())
            .flatMap(post -> Stream.concat(
                    Stream.of(Map.of(post.getValue().getAuthor(), post.getValue().getClientId())),
                    post.getValue().getComments().values().stream().map(comment -> Map.of(comment.getAuthor(), comment.getClientId()))
            ))
            .collect(Collectors.toMap(
                    e -> e.entrySet().iterator().next().getKey(),
                    e -> e.entrySet().iterator().next().getValue(),
                    (v1, v2) -> v1
            ));

    POSTS.entrySet().removeIf(entry -> entry.getValue().getExpire() <= System.nanoTime());

    Set<String> allAuthors = POSTS.entrySet().stream()
            .flatMap(post -> Stream.concat(
                    Stream.of(post.getValue().getAuthor()),
                    post.getValue().getComments().values().stream().map(Post::getAuthor)))
            .collect(Collectors.toSet());

    authorsClientId.entrySet().stream()
            .filter(author -> !allAuthors.contains(author.getKey()))
            .forEach(author -> ClientAuthors.returnAuthor(author.getValue()));
  }

  @Scheduled(fixedRate = 60000L)
  public void clearOld() {
    deletePostsByTime();
  }
}
